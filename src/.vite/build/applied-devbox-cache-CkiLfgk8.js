"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("node:fs/promises"),E=require("node:path"),d=require("./main-CQwPb0Th.js");require("path");require("node:fs");require("node:crypto");require("node:child_process");require("node:buffer");require("node:os");require("node:string_decoder");require("node:net");require("crypto");require("child_process");const s=d.getTaggedLoggerLazy("applied-devbox-cache"),A=3e4,O=2e4,S="host-cache",x="applied-devbox-ls.json";function w(e){return E.join(e,S,x)}function b(){const e=process.env.CODEX_APP_APPLIED_DEVBOX_REFRESH_INTERVAL_MS;if(!e)return A;const t=Number(e);return!Number.isFinite(t)||t<=0?(s().warning("Invalid CODEX_APP_APPLIED_DEVBOX_REFRESH_INTERVAL_MS",{value:e}),A):t}function g(e){const t=e.trim();if(!t)return[];try{const i=JSON.parse(t);if(!Array.isArray(i))return s().warning("Applied devbox ls returned non-array JSON",{payloadPreview:t.slice(0,200)}),null;const n=i.filter(r=>typeof r=="string").map(r=>r.trim()).filter(r=>r.length>0);return[...new Set(n)]}catch{return s().warning("Applied devbox ls returned invalid JSON",{payloadPreview:t.slice(0,200)}),null}}async function h(e,t){await a.mkdir(E.dirname(e),{recursive:!0,mode:448});const i=`${e}.tmp-${process.pid}-${Date.now()}`;await a.writeFile(i,t,{encoding:"utf8",mode:384});try{await a.rename(i,e)}catch(n){const r=n?.code;if(r==="EEXIST"||r==="EPERM")await a.unlink(e).catch(()=>{}),await a.rename(i,e);else throw await a.unlink(i).catch(()=>{}),n}await a.chmod(e,384).catch(()=>{})}function C(e){const t=w(e.codexHome),i=e.refreshIntervalMs??b(),n=e.timeoutMs??O;let r=!1,o=!1,l=null;const p=async()=>{if(r||o)return;o=!0;const c=new AbortController;l=c;let f=!1;const y=setTimeout(()=>{f=!0,c.abort()},n);try{const u=d.spawnAsync({args:["applied","devbox","ls","--format","json"],signal:c.signal}),{stdout:D,stderr:I,code:v}=await u.wait();if(r)return;if(f){s().warning("Applied devbox ls timed out",{timeoutMs:n});return}if(v!==0){s().warning("Applied devbox ls failed",{code:v,stderr:I.trim()||null});return}const m=g(D);if(m==null)return;await h(t,JSON.stringify(m)),e.onCacheUpdated?.()}catch(u){if(r)return;s().warning("Applied devbox cache refresh failed",{error:d.sanitizeLogValue(u)})}finally{clearTimeout(y),o=!1,l=null}};p();const _=setInterval(()=>{p()},i);return{dispose:()=>{r=!0,clearInterval(_),l?.abort()}}}exports.atomicWriteCacheFile=h;exports.parseAppliedDevboxLsOutput=g;exports.resolveAppliedDevboxCachePath=w;exports.resolveRefreshIntervalMs=b;exports.startAppliedDevboxCacheRefresher=C;
//# sourceMappingURL=applied-devbox-cache-CkiLfgk8.js.map
